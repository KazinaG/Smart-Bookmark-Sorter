# AGENTS.md

この文書は、エージェントが最初に確認すべき最小ルールをまとめたものです。詳細は `docs/` 配下の一次情報を参照します。

## 目的と参照先

- まず `docs/README.md` を確認し、必要な一次情報へトップダウンで辿る。
- 仕様・運用の正本は `docs/`。AGENTS.md には要点と導線だけを置く。
- 回答では確認した一次情報を明記する。

## 規約運用の優先順位

1. 事故防止
2. 最低限の変更追跡性
3. 認知負荷最小化
4. 意思決定速度

定義と判断基準は `docs/policies/development-principles.md` を参照します。

## 最小ガード（必須）

- 進め方は「提案 → 明示承認 → 反映」。
- 実装開始は `実装OK: <scope>` を必須とする。
- 編集・ステージング・コミットは `worktrees/<branch>` のみ。`main` は読み取り専用。
- 仕様変更時は DOCS-first で Spec Delta を先に反映する。
- `main` 取り込みと Push は `docs/policies/approval.md` の承認語彙に従う。
- `Merge承認` 実行後（`main` 取り込み完了後）は後片付けを既定で実施する（詳細は `docs/dev-practices/operations.md`）。
- 後片付けを保留する場合のみ、`後片付け保留` を明示する。

## ハーネス委譲

以下はハーネス側で担保されるため、リポジトリ文書で重複管理しません。

- 実行環境の権限制御とエスカレーション手順。
- 応答フォーマットやツール利用の一般ルール。
- 汎用的な安全ガード。

## コミュニケーション

- 応答は日本語で、事実・推測・提案を分ける。
- 高レベルの会話を優先し、詳細は必要時に段階的に提示する。
- 不確実な前提は確認してから反映する。
- 承認語彙を提示する場合は、必ずコードブロックで提示する（インライン提示はしない）。
- 承認語彙の文字列はクォートで囲まない（例: `実装OK: <scope>`）。

## 進行・承認ヘッダ

通常応答の冒頭に次のヘッダを付けます。キー表記は `【】` を使用します。
通常応答は、ユーザーの判断・理解・記録に直接関わる応答を指し、次を含みます。

- ユーザーへの回答本体
- ユーザー判断が必要な質問
- 承認語彙の提示
- フェーズ遷移の宣言
- 最終報告

短い進捗通知（独り言に近い作業ログ）は通常応答に含めず、ヘッダを付けません。
全体目的は見出し（`# ...`）として固定し、フェーズ間で変更しません。
フェーズ表示は次の固定順を毎回表示し、現在地のみ `🟢`、それ以外は `⚪` を使います。
`方針相談`（=STEP1）→ `仕様確定`（=STEP2）→ `実装検証`（=STEP3）→ `整合確認`（=STEP4）→ `反映承認`（=STEP5）
ヘッダ末尾は Markdown 水平線ではなく `─────` を使って本文と分離します。
`─────` はバレットリストから 1 行空けて記載し、長さはヘッダ本文の幅に合わせて調整します。

- 常時必須
  - 見出し（`# <全体目的>`） `【フェーズ】` `【小目標】` `【応答目的】` `【確認ドキュメント】` `【現在地→次】`
- 実行時に必須（編集/コマンド実行を伴う場合）
  - `【範囲/除外】` `【Worktree/Branch】` `【CWD】` `【承認状態】`
- 任意
  - `【成功条件】` `【Issue】`

```text
# <全体目的>

- 【フェーズ】 🟢方針相談 → ⚪仕様確定 → ⚪実装検証 → ⚪整合確認 → ⚪反映承認
- 【小目標】 …
- 【成功条件】 …
- 【範囲/除外】 … / …
- 【Worktree/Branch】 … / …
- 【CWD】 …
- 【承認状態】 実装OK済み|承認不要|承認待ち …
- 【Issue】 …
- 【応答目的】 …
- 【確認ドキュメント】 docs/README.md, …
- 【現在地→次】 … → …

────────────────────────（長さはヘッダ本文幅に合わせて調整）
```

## 推奨ドキュメント

- `docs/policies/approval.md`
- `docs/policies/development-principles.md`
- `docs/dev-practices/process.md`
- `docs/dev-practices/operations.md`
- `docs/dev-practices/commit.md`
- `docs/dev-practices/linting.md`

## ガイドライン更新

- 乖離や摩擦を見つけたら改善提案を行い、承認後に反映する。
- AGENTS.md の更新も「提案 → 明示承認 → 反映」を守る。
